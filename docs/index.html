<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Interactive Speech Enhancement Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      --bg: #020617;
      --bg-soft: #030712;
      --card: #020617;
      --card-alt: #020617;
      --accent: #38bdf8;
      --accent-soft: rgba(56,189,248,0.16);
      --accent-strong: #0ea5e9;
      --border: #1f2937;
      --border-soft: #0f172a;
      --text-main: #e5e7eb;
      --text-soft: #9ca3af;
      --chip-bg: rgba(15,23,42,0.98);
      --shadow-strong: 0 24px 60px rgba(0,0,0,0.85);
      --shadow-soft: 0 16px 40px rgba(15,23,42,0.9);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }

    body {
      min-height: 100vh;
      background:
        radial-gradient(circle at top, #1e293b 0, #020617 36%, #000 100%);
      color: var(--text-main);
      padding: 28px 16px 40px 16px;
    }

    main {
      max-width: 1240px;
      margin: 0 auto;
    }

    h1 {
      font-size: 32px;
      letter-spacing: 0.05em;
      text-align: center;
      margin-bottom: 6px;
    }

    .subtitle-main {
      text-align: center;
      font-size: 14px;
      color: var(--text-soft);
      margin-bottom: 26px;
    }

    .chips-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
      margin-bottom: 26px;
    }

    .chip {
      border-radius: 999px;
      background: rgba(15,23,42,0.96);
      border: 1px solid rgba(148,163,184,0.4);
      padding: 4px 12px;
      font-size: 11px;
      color: var(--text-soft);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .chip-flag {
      width: 9px;
      height: 9px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 4px rgba(34,197,94,0.15);
    }

    .chip strong {
      color: var(--text-main);
    }

    .grid-main {
      display: grid;
      grid-template-columns: minmax(0, 1.7fr) minmax(0, 1.4fr);
      gap: 20px;
      margin-bottom: 22px;
    }

    @media (max-width: 940px) {
      .grid-main {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: radial-gradient(circle at top left, #020617 0, #020617 55%, #020617 100%);
      border-radius: 20px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow-strong);
      padding: 18px 20px 20px 20px;
    }

    .card-alt {
      background: radial-gradient(circle at top left, #020617 0, #020617 70%, #020617 100%);
      border-radius: 20px;
      border: 1px solid var(--border-soft);
      box-shadow: var(--shadow-soft);
      padding: 18px 20px 20px 20px;
    }

    .header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 8px;
    }

    .title-main {
      font-size: 18px;
      letter-spacing: 0.03em;
    }

    .tag-soft {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--accent);
      border-radius: 999px;
      border: 1px solid rgba(56,189,248,0.45);
      background: rgba(15,23,42,0.9);
      padding: 4px 10px;
      white-space: nowrap;
    }

    p {
      font-size: 13px;
      line-height: 1.55;
      color: var(--text-soft);
    }

    .label {
      font-size: 12px;
      color: var(--text-soft);
      margin-bottom: 3px;
    }

    .row-two {
      display: grid;
      grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
      gap: 10px;
      margin-top: 12px;
    }

    .audio-strip {
      background: rgba(15,23,42,0.96);
      border-radius: 999px;
      border: 1px solid rgba(30,64,175,0.55);
      padding: 6px 10px 6px 14px;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .audio-strip h3 {
      font-size: 12px;
      font-weight: 500;
      color: var(--text-main);
    }

    audio {
      width: 100%;
    }

    .divider {
      height: 1px;
      background: linear-gradient(to right, transparent, rgba(30,64,175,0.9), transparent);
      margin: 14px 0 10px 0;
    }

    .image-block {
      margin-top: 8px;
    }

    .image-caption {
      font-size: 11px;
      color: var(--text-soft);
      margin-top: 4px;
    }

    .image-row {
      display: grid;
      grid-template-columns: minmax(0,1fr);
      gap: 8px;
    }

    .image-row img,
    .image-block img {
      width: 100%;
      border-radius: 14px;
      border: 1px solid rgba(30,64,175,0.6);
      background: #020617;
    }

    .snr-img {
      margin-top: 8px;
    }

    .snr-img img {
      width: 100%;
      border-radius: 14px;
      border: 1px solid rgba(30,64,175,0.6);
      background: #020617;
    }

    .snr-caption {
      font-size: 11px;
      margin-top: 4px;
      color: var(--text-soft);
    }

    /* Playground */

    .section-heading {
      font-size: 18px;
      margin-bottom: 6px;
      letter-spacing: 0.03em;
    }

    .playground-grid {
      display: grid;
      grid-template-columns: minmax(0, 2.1fr) minmax(0, 1.2fr);
      gap: 16px;
      margin-top: 10px;
    }

    @media (max-width: 900px) {
      .playground-grid {
        grid-template-columns: 1fr;
      }
    }

    .field {
      margin-bottom: 10px;
    }

    .field label {
      display: block;
      font-size: 12px;
      margin-bottom: 2px;
      color: var(--text-soft);
    }

    input[type="file"] {
      font-size: 12px;
      color: var(--text-soft);
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 6px;
    }

    button {
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.45);
      background: rgba(15,23,42,0.98);
      color: var(--text-main);
      padding: 6px 12px;
      font-size: 12px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    button.primary {
      background: radial-gradient(circle at top left, var(--accent) 0, #1d4ed8 45%, #020617 100%);
      border-color: rgba(56,189,248,0.9);
      color: #020617;
      font-weight: 600;
    }

    button:disabled {
      opacity: 0.45;
      cursor: not-allowed;
    }

    .slider-row {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    input[type="range"] {
      flex: 1;
    }

    #snrValue {
      width: 40px;
      font-size: 12px;
      text-align: right;
      color: var(--text-main);
    }

    .status {
      font-size: 11px;
      color: var(--text-soft);
      margin-top: 4px;
      min-height: 16px;
    }

    .status span.ok { color: #22c55e; }
    .status span.warn { color: #eab308; }
    .status span.err { color: #f97373; }

    .code-badge {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
      background: rgba(15,23,42,0.96);
      border-radius: 999px;
      padding: 2px 8px;
      border: 1px solid rgba(148,163,184,0.4);
      color: var(--text-soft);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .footer-note {
      font-size: 11px;
      color: var(--text-soft);
      margin-top: 6px;
    }

    a {
      color: var(--accent-strong);
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
<main>
  <header>
    <h1>Interactive Speech Enhancement Demo</h1>
    <p class="subtitle-main">
      Real speech, classical denoisers evaluated in MATLAB, and a browser-based noise playground.
    </p>
    <div class="chips-row">
      <div class="chip">
        <span class="chip-flag"></span>
        <strong>ELEC5305</strong> Adaptive Hybrid Speech Denoising
      </div>
      <div class="chip">
        <strong>Baselines:</strong> Wiener · Spectral subtraction
      </div>
      <div class="chip">
        <strong>Hybrid:</strong> SNR-adaptive combination
      </div>
      <div class="chip">
        <strong>Metrics:</strong> SNR improvement (dB)
      </div>
    </div>
  </header>

  <!-- TOP GRID: FIXED EXAMPLE + BATCH EXPERIMENTS -->
  <section class="grid-main">
    <!-- LEFT: FIXED EXAMPLE -->
    <article class="card">
      <div class="header-row">
        <h2 class="title-main">Fixed Example · OSR_us_000_0031_8k</h2>
        <span class="tag-soft">Clean vs Noisy vs Denoised</span>
      </div>
      <p>
        A real English sentence from the Open Speech Repository is mixed with synthetic noise and
        enhanced by three classical methods implemented in MATLAB.
      </p>

      <div class="row-two" style="margin-top:12px;">
        <div class="audio-strip">
          <h3>Clean speech</h3>
          <audio controls src="../examples/osr_0031/OSR_us_000_0031_8k.wav"></audio>
        </div>
        <div class="audio-strip">
          <h3>Noisy mixture</h3>
          <audio controls src="../results/noisy.wav"></audio>
        </div>
      </div>

      <div class="row-two" style="margin-top:10px;">
        <div class="audio-strip">
          <h3>Wiener denoised</h3>
          <audio controls src="../results/wiener_denoised.wav"></audio>
        </div>
        <div class="audio-strip">
          <h3>Spectral subtraction denoised</h3>
          <audio controls src="../results/spectral_denoised.wav"></audio>
        </div>
      </div>

      <div class="audio-strip" style="margin-top:10px;">
        <h3>Adaptive hybrid denoised</h3>
        <audio controls src="../results/hybrid_denoised.wav"></audio>
      </div>

      <div class="divider"></div>

      <div class="image-block">
        <div class="label">Waveform comparison</div>
        <div class="image-row">
          <img src="../results/comparison_waveforms.png"
               alt="Waveform comparison for clean, noisy, Wiener, spectral subtraction and hybrid speech." />
        </div>
        <p class="image-caption">
          Waveform comparison for OSR_us_000_0031_8k: clean, noisy, Wiener, spectral subtraction and
          adaptive hybrid outputs.
        </p>
      </div>
    </article>

    <!-- RIGHT: BATCH EXPERIMENTS -->
    <article class="card-alt">
      <div class="header-row">
        <h2 class="title-main">Batch Experiments · SNR Improvement</h2>
        <span class="tag-soft">Whitehum · Highfreq · Babble</span>
      </div>
      <p>
        The denoisers are evaluated systematically across multiple speech files, noise types and input
        SNR levels (0 / 5 / 10 / 15 dB). Each bar shows the average SNR improvement over the noisy
        reference.
      </p>

      <div class="snr-img">
        <img src="../results/exp_whitehum_snr_improvement.png"
             alt="SNR improvement for white + 50 Hz hum noise." />
        <p class="snr-caption">
          SNR improvement vs input SNR for <strong>white + 50&nbsp;Hz hum noise</strong>. Spectral subtraction
          achieves the largest gain at low SNR, while the hybrid method remains conservative to avoid
          speech distortion.
        </p>
      </div>

      <div class="snr-img">
        <img src="../results/exp_highfreq_snr_improvement.png"
             alt="SNR improvement for high-frequency noise." />
        <p class="snr-caption">
          SNR improvement for <strong>high-frequency noise</strong>. Wiener filtering is strong in this regime,
          reflecting its ability to track stationary residual hiss.
        </p>
      </div>

      <div class="snr-img">
        <img src="../results/exp_babble_snr_improvement.png"
             alt="SNR improvement for babble noise." />
        <p class="snr-caption">
          SNR improvement for <strong>multi-speaker babble noise</strong>. All methods offer moderate gain; the
          hybrid filter tends to preserve more speech detail at the cost of smaller SNR improvement.
        </p>
      </div>

      <p class="footer-note">
        All figures are generated in MATLAB using <span class="code-badge">run_batch_experiments.m</span>
        and <span class="code-badge">plot_experiment_results.m</span>, and exported as static PNG files.
      </p>
    </article>
  </section>

  <!-- PLAYGROUND -->
  <section class="card" style="margin-top:20px;">
    <h2 class="section-heading">Browser Noise Playground (Client-Side Only)</h2>
    <p>
      The full denoising algorithms run offline in MATLAB. This lightweight playground is implemented
      purely in JavaScript using the Web Audio API: you can upload a clean speech file, add synthetic
      noise at a chosen input SNR, and listen to the resulting noisy mixture. No data ever leaves your
      browser.
    </p>

    <div class="playground-grid">
      <!-- controls -->
      <div>
        <div class="field" style="margin-top:12px;">
          <label for="fileInput">1. Upload a WAV file (mono recommended)</label>
          <input id="fileInput" type="file"
                 accept="audio/wav,audio/wave,audio/x-wav,audio/*" />
        </div>

        <div class="field">
          <label>2. Choose noise type</label>
          <div class="btn-row">
            <button type="button" class="noise-btn primary" data-noise="white">White</button>
            <button type="button" class="noise-btn" data-noise="babble">Babble-like</button>
            <button type="button" class="noise-btn" data-noise="highfreq">High-frequency</button>
          </div>
        </div>

        <div class="field">
          <label>3. Set input SNR (dB)</label>
          <div class="slider-row">
            <input id="snrSlider" type="range" min="-5" max="20" step="1" value="5" />
            <span id="snrValue">5 dB</span>
          </div>
        </div>

        <div class="field">
          <label>4. Playback</label>
          <div class="btn-row">
            <button id="playCleanBtn" type="button" disabled>▶ Play clean</button>
            <button id="playNoisyBtn" type="button" class="primary" disabled>▶ Play noisy mixture</button>
            <button id="stopBtn" type="button" disabled>■ Stop</button>
          </div>
        </div>

        <div id="statusLine" class="status">
          <span class="warn">Upload a WAV file to start the playground.</span>
        </div>
      </div>

      <!-- explanation -->
      <div>
        <p class="label">How it works</p>
        <p>
          When you click <strong>Play noisy mixture</strong>, the browser generates white / babble-like /
          high-frequency noise with the same length as the uploaded signal. The noise amplitude is scaled
          such that the power ratio between clean and noise approximates the requested input SNR.
        </p>
        <p style="margin-top:8px;">
          This interactive panel is designed to complement the MATLAB experiments:
        </p>
        <ul style="margin-top:6px; margin-left:18px; font-size:13px; color:var(--text-soft); line-height:1.5;">
          <li>It illustrates perceptual differences between noise types.</li>
          <li>It shows how increasing the input SNR makes the speech more intelligible even before denoising.</li>
          <li>It allows non-MATLAB users to explore the task without installing toolboxes.</li>
        </ul>
        <p class="footer-note">
          Note: This playground performs <em>noise synthesis only</em>. All denoised examples and evaluation
          plots on this page are generated offline using the MATLAB code in this repository.
        </p>
      </div>
    </div>
  </section>

  <!-- FOOTER -->
  <section class="card-alt" style="margin-top:18px;">
    <div class="header-row" style="margin-bottom:4px;">
      <h2 class="title-main">Project Repository</h2>
      <span class="tag-soft">GitHub</span>
    </div>
    <p>
      Full MATLAB implementation, experiment scripts and the written report are available at:
      <a href="https://github.com/TengfeiWang5305/elec5305-project-TengfeiWang-540542743" target="_blank">
        github.com/TengfeiWang5305/elec5305-project-TengfeiWang-540542743
      </a>.
    </p>
  </section>
</main>

<script>
  // --- Simple Web Audio playground (client-side only) ---
  let audioCtx = null;
  let cleanBuffer = null;
  let currentNoiseType = "white";
  let currentNodes = [];

  const fileInput = document.getElementById("fileInput");
  const snrSlider = document.getElementById("snrSlider");
  const snrValue = document.getElementById("snrValue");
  const playCleanBtn = document.getElementById("playCleanBtn");
  const playNoisyBtn = document.getElementById("playNoisyBtn");
  const stopBtn = document.getElementById("stopBtn");
  const statusLine = document.getElementById("statusLine");
  const noiseBtns = document.querySelectorAll(".noise-btn");

  function setStatus(html, cls) {
    statusLine.innerHTML = `<span class="${cls}">${html}</span>`;
  }

  snrSlider.addEventListener("input", () => {
    snrValue.textContent = `${snrSlider.value} dB`;
  });

  // choose noise type
  noiseBtns.forEach(btn => {
    btn.addEventListener("click", () => {
      noiseBtns.forEach(b => b.classList.remove("primary"));
      btn.classList.add("primary");
      currentNoiseType = btn.dataset.noise;
      setStatus(`Noise type set to ${currentNoiseType}.`, "ok");
    });
  });

  // upload & decode
  fileInput.addEventListener("change", async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    try {
      if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      }
      const arrayBuf = await file.arrayBuffer();
      cleanBuffer = await audioCtx.decodeAudioData(arrayBuf);

      playCleanBtn.disabled = false;
      playNoisyBtn.disabled = false;
      stopBtn.disabled = false;

      setStatus(
        `Loaded file: ${file.name}. Channels: ${cleanBuffer.numberOfChannels}, duration: ${cleanBuffer.duration.toFixed(2)} s.`,
        "ok"
      );
    } catch (err) {
      console.error(err);
      setStatus("Could not decode this audio file. Please try a different WAV file.", "err");
    }
  });

  function stopAll() {
    currentNodes.forEach(node => {
      try { node.stop(); } catch (e) {}
    });
    currentNodes = [];
  }

  // play clean only
  playCleanBtn.addEventListener("click", () => {
    if (!cleanBuffer || !audioCtx) return;
    stopAll();

    const src = audioCtx.createBufferSource();
    src.buffer = cleanBuffer;
    src.connect(audioCtx.destination);
    src.start();

    currentNodes.push(src);
    setStatus("Playing clean speech only.", "ok");
  });

  function createNoiseBuffer(type) {
    const channels = cleanBuffer.numberOfChannels;
    const length = cleanBuffer.length;
    const sr = cleanBuffer.sampleRate;
    const noiseBuf = audioCtx.createBuffer(channels, length, sr);

    for (let ch = 0; ch < channels; ch++) {
      const data = noiseBuf.getChannelData(ch);
      for (let i = 0; i < length; i++) {
        // base white noise
        let n = Math.random() * 2 - 1;

        if (type === "babble") {
          n += 0.4 * Math.sin(2 * Math.PI * 200 * i / sr + Math.random() * 2 * Math.PI);
          n += 0.3 * Math.sin(2 * Math.PI * 400 * i / sr + Math.random() * 2 * Math.PI);
        } else if (type === "highfreq") {
          const phi = 2 * Math.PI * 2500 * i / sr;
          n += 0.6 * Math.sin(phi + Math.random() * 2 * Math.PI);
        }

        data[i] = n;
      }
    }

    return noiseBuf;
  }

  // play mixture at target SNR
  playNoisyBtn.addEventListener("click", () => {
    if (!cleanBuffer || !audioCtx) return;
    stopAll();

    const snrDb = parseFloat(snrSlider.value);
    const noiseAmp = Math.pow(10, -snrDb / 20);

    const cleanSrc = audioCtx.createBufferSource();
    cleanSrc.buffer = cleanBuffer;

    const noiseBuf = createNoiseBuffer(currentNoiseType);
    const noiseSrc = audioCtx.createBufferSource();
    noiseSrc.buffer = noiseBuf;

    const cleanGain = audioCtx.createGain();
    cleanGain.gain.value = 1.0;

    const noiseGain = audioCtx.createGain();
    noiseGain.gain.value = noiseAmp;

    cleanSrc.connect(cleanGain).connect(audioCtx.destination);
    noiseSrc.connect(noiseGain).connect(audioCtx.destination);

    cleanSrc.start();
    noiseSrc.start();

    currentNodes.push(cleanSrc, noiseSrc);
    setStatus(
      `Playing synthetic mixture (noise: ${currentNoiseType}, target SNR ≈ ${snrDb} dB).`,
      "ok"
    );
  });

  stopBtn.addEventListener("click", () => {
    stopAll();
    setStatus("Playback stopped.", "warn");
  });
</script>
</body>
</html>
